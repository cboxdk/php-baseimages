name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'php-fpm-nginx/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'php-fpm-nginx/**'
      - 'tests/e2e/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to test'
        required: false
        default: '8.3'
        type: choice
        options:
          - '8.2'
          - '8.3'
          - '8.4'
          - 'all'
      os_variant:
        description: 'OS variant to test'
        required: false
        default: 'alpine'
        type: choice
        options:
          - 'alpine'
          - 'debian'
          - 'ubuntu'
          - 'all'
      scenario:
        description: 'Test scenario to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'plain-php'
          - 'laravel'
          - 'wordpress'
          - 'health-checks'

env:
  REGISTRY: ghcr.io/phpeek/baseimages

jobs:
  # Quick smoke test on every push
  smoke-test:
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker build \
            -f php-fpm-nginx/8.3/alpine/Dockerfile \
            -t test-image:local \
            .

      - name: Run plain PHP E2E test
        env:
          IMAGE: test-image:local
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" plain-php

      - name: Run health check E2E test
        env:
          IMAGE: test-image:local
        run: |
          tests/e2e/run-e2e-tests.sh "$IMAGE" health-checks

  # Full matrix test (manual trigger or scheduled)
  full-matrix:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        php_version: ${{ github.event.inputs.php_version == 'all' && fromJson('["8.2", "8.3", "8.4"]') || fromJson(format('["{0}"]', github.event.inputs.php_version)) }}
        os_variant: ${{ github.event.inputs.os_variant == 'all' && fromJson('["alpine", "debian", "ubuntu"]') || fromJson(format('["{0}"]', github.event.inputs.os_variant)) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker build \
            -f php-fpm-nginx/${{ matrix.php_version }}/${{ matrix.os_variant }}/Dockerfile \
            -t test-image:${{ matrix.php_version }}-${{ matrix.os_variant }} \
            .

      - name: Run E2E tests
        env:
          IMAGE: test-image:${{ matrix.php_version }}-${{ matrix.os_variant }}
          SCENARIO: ${{ github.event.inputs.scenario }}
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" "$SCENARIO"

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.php_version }}-${{ matrix.os_variant }}
          path: /tmp/e2e-*.log
          retention-days: 7

  # Comprehensive test on main branch pushes
  comprehensive:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          # Test one version per OS for comprehensive coverage
          - php_version: '8.3'
            os_variant: 'alpine'
            scenario: 'all'
          - php_version: '8.3'
            os_variant: 'debian'
            scenario: 'plain-php'
          - php_version: '8.3'
            os_variant: 'ubuntu'
            scenario: 'plain-php'
          # Also test latest PHP on Alpine
          - php_version: '8.4'
            os_variant: 'alpine'
            scenario: 'all'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker build \
            -f php-fpm-nginx/${{ matrix.php_version }}/${{ matrix.os_variant }}/Dockerfile \
            -t test-image:${{ matrix.php_version }}-${{ matrix.os_variant }} \
            .

      - name: Run E2E tests
        env:
          IMAGE: test-image:${{ matrix.php_version }}-${{ matrix.os_variant }}
        run: |
          chmod +x tests/e2e/run-e2e-tests.sh
          chmod +x tests/e2e/scenarios/*.sh
          chmod +x tests/e2e/lib/*.sh
          tests/e2e/run-e2e-tests.sh "$IMAGE" "${{ matrix.scenario }}"

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.php_version }}-${{ matrix.os_variant }}
          path: /tmp/e2e-*.log
          retention-days: 7

  # Summary job
  summary:
    if: always()
    needs: [smoke-test, comprehensive]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.smoke-test.result }}" == "failure" ] || [ "${{ needs.comprehensive.result }}" == "failure" ]; then
            echo "::error::E2E tests failed"
            exit 1
          fi
          echo "All E2E tests passed!"
