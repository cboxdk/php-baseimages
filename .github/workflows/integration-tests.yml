name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  framework-detection-tests:
    name: Framework Detection Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          chmod +x tests/integration/framework-detection/test-runner.sh
          ./tests/integration/framework-detection/test-runner.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read PHPeek PM version
        id: versions
        run: |
          echo "PHPEEK_PM_VERSION=$(jq -r '.tools.phpeek_pm' versions.json)" >> $GITHUB_OUTPUT

      - name: Download PHPeek PM binaries
        run: |
          mkdir -p phpeek-pm/binaries
          VERSION="${{ steps.versions.outputs.PHPEEK_PM_VERSION }}"
          BASE_URL="https://github.com/gophpeek/phpeek-pm/releases/download/v${VERSION}"
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-amd64" -o phpeek-pm/binaries/phpeek-pm-linux-amd64
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-arm64" -o phpeek-pm/binaries/phpeek-pm-linux-arm64
          chmod +x phpeek-pm/binaries/phpeek-pm-*

      - name: Build image chain (php-base → php-fpm → php-fpm-nginx)
        run: |
          # Alpine
          echo "=== Building Alpine chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-alpine -f php-base/8.3/alpine/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-alpine -f php-fpm/8.3/alpine/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm-nginx:8.3-alpine -f php-fpm-nginx/8.3/alpine/Dockerfile .

          # Bookworm
          echo "=== Building Bookworm chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-bookworm -f php-base/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-bookworm -f php-fpm/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm-nginx:8.3-bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .

          # Trixie
          echo "=== Building Trixie chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-trixie -f php-base/8.3/debian/trixie/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-trixie -f php-fpm/8.3/debian/trixie/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm-nginx:8.3-trixie -f php-fpm-nginx/8.3/debian/trixie/Dockerfile .

      - name: Run Docker integration tests
        run: |
          chmod +x tests/integration/framework-detection/docker-test.sh
          ./tests/integration/framework-detection/docker-test.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/integration/framework-detection/fixtures/

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: framework-detection-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read PHPeek PM version
        id: versions
        run: |
          echo "PHPEEK_PM_VERSION=$(jq -r '.tools.phpeek_pm' versions.json)" >> $GITHUB_OUTPUT

      - name: Download PHPeek PM binaries
        run: |
          mkdir -p phpeek-pm/binaries
          VERSION="${{ steps.versions.outputs.PHPEEK_PM_VERSION }}"
          BASE_URL="https://github.com/gophpeek/phpeek-pm/releases/download/v${VERSION}"
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-amd64" -o phpeek-pm/binaries/phpeek-pm-linux-amd64
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-arm64" -o phpeek-pm/binaries/phpeek-pm-linux-arm64
          chmod +x phpeek-pm/binaries/phpeek-pm-*

      - name: Build benchmark image chain (php-base → php-fpm → php-fpm-nginx)
        run: |
          # Alpine
          echo "=== Building Alpine chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-alpine -f php-base/8.3/alpine/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-alpine -f php-fpm/8.3/alpine/Dockerfile .
          docker build --target root -t phpeek-alpine -f php-fpm-nginx/8.3/alpine/Dockerfile .

          # Bookworm
          echo "=== Building Bookworm chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-bookworm -f php-base/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-bookworm -f php-fpm/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t phpeek-bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .

          # Trixie
          echo "=== Building Trixie chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-trixie -f php-base/8.3/debian/trixie/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-trixie -f php-fpm/8.3/debian/trixie/Dockerfile .
          docker build --target root -t phpeek-trixie -f php-fpm-nginx/8.3/debian/trixie/Dockerfile .

      - name: Run performance benchmarks
        run: |
          chmod +x tests/benchmarks/run-benchmarks.sh
          ./tests/benchmarks/run-benchmarks.sh

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: tests/benchmarks/results/

  security-scan:
    name: CVE Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read PHPeek PM version
        id: versions
        run: |
          echo "PHPEEK_PM_VERSION=$(jq -r '.tools.phpeek_pm' versions.json)" >> $GITHUB_OUTPUT

      - name: Download PHPeek PM binaries
        run: |
          mkdir -p phpeek-pm/binaries
          VERSION="${{ steps.versions.outputs.PHPEEK_PM_VERSION }}"
          BASE_URL="https://github.com/gophpeek/phpeek-pm/releases/download/v${VERSION}"
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-amd64" -o phpeek-pm/binaries/phpeek-pm-linux-amd64
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-arm64" -o phpeek-pm/binaries/phpeek-pm-linux-arm64
          chmod +x phpeek-pm/binaries/phpeek-pm-*

      - name: Build images for scanning (full chain)
        run: |
          # Alpine chain
          echo "=== Building Alpine chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-alpine -f php-base/8.3/alpine/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-alpine -f php-fpm/8.3/alpine/Dockerfile .
          docker build --target root -t phpeek-scan:alpine -f php-fpm-nginx/8.3/alpine/Dockerfile .

          # Bookworm chain
          echo "=== Building Bookworm chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-bookworm -f php-base/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-bookworm -f php-fpm/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t phpeek-scan:bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .

          # Trixie chain
          echo "=== Building Trixie chain ==="
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-base:8.3-trixie -f php-base/8.3/debian/trixie/Dockerfile .
          docker build --target root -t ghcr.io/gophpeek/baseimages/php-fpm:8.3-trixie -f php-fpm/8.3/debian/trixie/Dockerfile .
          docker build --target root -t phpeek-scan:trixie -f php-fpm-nginx/8.3/debian/trixie/Dockerfile .

      - name: Run Trivy vulnerability scanner (Alpine)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'phpeek-scan:alpine'
          format: 'sarif'
          output: 'trivy-alpine-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner (Bookworm)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'phpeek-scan:bookworm'
          format: 'sarif'
          output: 'trivy-bookworm-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner (Trixie)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'phpeek-scan:trixie'
          format: 'sarif'
          output: 'trivy-trixie-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab (Alpine)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-alpine-results.sarif
          category: trivy-alpine

      - name: Upload Trivy results to GitHub Security tab (Bookworm)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-bookworm-results.sarif
          category: trivy-bookworm

      - name: Upload Trivy results to GitHub Security tab (Trixie)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-trixie-results.sarif
          category: trivy-trixie

      - name: Generate security report summary
        if: always()
        run: |
          echo "# Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Alpine" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table phpeek-scan:alpine >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bookworm (Debian 12)" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table phpeek-scan:bookworm >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Trixie (Debian 13)" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table phpeek-scan:trixie >> $GITHUB_STEP_SUMMARY || true
