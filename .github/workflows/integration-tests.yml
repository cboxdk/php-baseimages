name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  framework-detection-tests:
    name: Framework Detection Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          chmod +x tests/integration/framework-detection/test-runner.sh
          ./tests/integration/framework-detection/test-runner.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read Cbox PM version
        id: versions
        run: |
          echo "CBOX_PM_VERSION=$(jq -r '.tools.cbox_pm' versions.json)" >> $GITHUB_OUTPUT

      - name: Download and verify Cbox PM binaries
        run: |
          mkdir -p cbox-pm/binaries
          VERSION="${{ steps.versions.outputs.CBOX_PM_VERSION }}"
          BASE_URL="https://github.com/gophpeek/phpeek-pm/releases/download/v${VERSION}"

          echo "Downloading Cbox PM v${VERSION}..."
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-amd64" -o cbox-pm/binaries/phpeek-pm-linux-amd64
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-arm64" -o cbox-pm/binaries/phpeek-pm-linux-arm64
          curl -fsSL "${BASE_URL}/checksums.txt" -o cbox-pm/binaries/checksums.txt

          echo "Verifying SHA256 checksums..."
          cd cbox-pm/binaries
          grep -E "phpeek-pm-linux-(amd64|arm64)$" checksums.txt | sha256sum -c -

          # Rename to cbox-pm for the build
          mv phpeek-pm-linux-amd64 cbox-pm-linux-amd64
          mv phpeek-pm-linux-arm64 cbox-pm-linux-arm64
          cd -

          chmod +x cbox-pm/binaries/cbox-pm-*

      - name: Build image chain (php-base → php-fpm → php-fpm-nginx)
        run: |
          echo "=== Building Bookworm chain ==="
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-base:8.3-bookworm -f php-base/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-fpm:8.3-bookworm -f php-fpm/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-fpm-nginx:8.3-bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .

      - name: Run Docker integration tests
        run: |
          chmod +x tests/integration/framework-detection/docker-test.sh
          ./tests/integration/framework-detection/docker-test.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/integration/framework-detection/fixtures/

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: framework-detection-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read Cbox PM version
        id: versions
        run: |
          echo "CBOX_PM_VERSION=$(jq -r '.tools.cbox_pm' versions.json)" >> $GITHUB_OUTPUT

      - name: Download and verify Cbox PM binaries
        run: |
          mkdir -p cbox-pm/binaries
          VERSION="${{ steps.versions.outputs.CBOX_PM_VERSION }}"
          BASE_URL="https://github.com/gophpeek/phpeek-pm/releases/download/v${VERSION}"

          echo "Downloading Cbox PM v${VERSION}..."
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-amd64" -o cbox-pm/binaries/phpeek-pm-linux-amd64
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-arm64" -o cbox-pm/binaries/phpeek-pm-linux-arm64
          curl -fsSL "${BASE_URL}/checksums.txt" -o cbox-pm/binaries/checksums.txt

          echo "Verifying SHA256 checksums..."
          cd cbox-pm/binaries
          grep -E "phpeek-pm-linux-(amd64|arm64)$" checksums.txt | sha256sum -c -

          # Rename to cbox-pm for the build
          mv phpeek-pm-linux-amd64 cbox-pm-linux-amd64
          mv phpeek-pm-linux-arm64 cbox-pm-linux-arm64
          cd -

          chmod +x cbox-pm/binaries/cbox-pm-*

      - name: Build benchmark image chain (php-base → php-fpm → php-fpm-nginx)
        run: |
          echo "=== Building Bookworm chain ==="
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-base:8.3-bookworm -f php-base/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-fpm:8.3-bookworm -f php-fpm/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t cbox-bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .

      - name: Run performance benchmarks
        run: |
          chmod +x tests/benchmarks/run-benchmarks.sh
          ./tests/benchmarks/run-benchmarks.sh

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: tests/benchmarks/results/

  security-scan:
    name: CVE Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read Cbox PM version
        id: versions
        run: |
          echo "CBOX_PM_VERSION=$(jq -r '.tools.cbox_pm' versions.json)" >> $GITHUB_OUTPUT

      - name: Download and verify Cbox PM binaries
        run: |
          mkdir -p cbox-pm/binaries
          VERSION="${{ steps.versions.outputs.CBOX_PM_VERSION }}"
          BASE_URL="https://github.com/gophpeek/phpeek-pm/releases/download/v${VERSION}"

          echo "Downloading Cbox PM v${VERSION}..."
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-amd64" -o cbox-pm/binaries/phpeek-pm-linux-amd64
          curl -fsSL "${BASE_URL}/phpeek-pm-linux-arm64" -o cbox-pm/binaries/phpeek-pm-linux-arm64
          curl -fsSL "${BASE_URL}/checksums.txt" -o cbox-pm/binaries/checksums.txt

          echo "Verifying SHA256 checksums..."
          cd cbox-pm/binaries
          grep -E "phpeek-pm-linux-(amd64|arm64)$" checksums.txt | sha256sum -c -

          # Rename to cbox-pm for the build
          mv phpeek-pm-linux-amd64 cbox-pm-linux-amd64
          mv phpeek-pm-linux-arm64 cbox-pm-linux-arm64
          cd -

          chmod +x cbox-pm/binaries/cbox-pm-*

      - name: Build images for scanning (full chain)
        run: |
          echo "=== Building Bookworm chain ==="
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-base:8.3-bookworm -f php-base/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t ghcr.io/cboxdk/baseimages/php-fpm:8.3-bookworm -f php-fpm/8.3/debian/bookworm/Dockerfile .
          docker build --target root -t cbox-scan:bookworm -f php-fpm-nginx/8.3/debian/bookworm/Dockerfile .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'cbox-scan:bookworm'
          format: 'sarif'
          output: 'trivy-bookworm-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-bookworm-results.sarif
          category: trivy-bookworm

      - name: Generate security report summary
        if: always()
        run: |
          echo "# Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Debian 12 (Bookworm)" >> $GITHUB_STEP_SUMMARY
          docker run --rm aquasec/trivy image --severity CRITICAL,HIGH --format table cbox-scan:bookworm >> $GITHUB_STEP_SUMMARY || true
