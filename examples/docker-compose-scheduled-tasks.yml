version: '3.8'

services:
  app:
    image: ghcr.io/phpeek/baseimages/php-fpm-nginx:8.3-alpine
    container_name: laravel-scheduled-tasks
    ports:
      - "8000:80"
      - "9090:9090"  # Prometheus metrics
    volumes:
      - ./:/var/www/html
    environment:
      # Enable PHPeek PM
      PHPEEK_PROCESS_MANAGER: phpeek-pm

      # Global settings
      PHPEEK_PM_LOG_LEVEL: info
      PHPEEK_PM_LOG_FORMAT: json
      PHPEEK_PM_METRICS_ENABLED: "true"
      PHPEEK_PM_METRICS_PORT: "9090"

      # Laravel optimizations
      LARAVEL_OPTIMIZE_CONFIG: "true"
      LARAVEL_OPTIMIZE_ROUTE: "true"
      LARAVEL_MIGRATE_ENABLED: "true"

      # Core processes
      PHPEEK_PM_PROCESS_PHP_FPM_ENABLED: "true"
      PHPEEK_PM_PROCESS_NGINX_ENABLED: "true"

      # Scheduled Tasks (v1.1.0+)

      # Cache warmup - every 15 minutes
      PHPEEK_PM_PROCESS_CACHE_WARMUP_ENABLED: "true"
      PHPEEK_PM_PROCESS_CACHE_WARMUP_COMMAND: "php,artisan,cache:warm"
      PHPEEK_PM_PROCESS_CACHE_WARMUP_SCHEDULE: "*/15 * * * *"
      PHPEEK_PM_PROCESS_CACHE_WARMUP_RESTART: "never"
      PHPEEK_PM_PROCESS_CACHE_WARMUP_PRIORITY: "60"

      # Database backup - daily at 2 AM with healthcheck monitoring
      PHPEEK_PM_PROCESS_DB_BACKUP_ENABLED: "true"
      PHPEEK_PM_PROCESS_DB_BACKUP_COMMAND: "php,artisan,backup:run"
      PHPEEK_PM_PROCESS_DB_BACKUP_SCHEDULE: "0 2 * * *"
      PHPEEK_PM_PROCESS_DB_BACKUP_RESTART: "never"
      PHPEEK_PM_PROCESS_DB_BACKUP_PRIORITY: "70"
      PHPEEK_PM_PROCESS_DB_BACKUP_HEARTBEAT_URL: "https://hc-ping.com/your-backup-uuid"
      PHPEEK_PM_PROCESS_DB_BACKUP_HEARTBEAT_TIMEOUT: "300"

      # Report generation - Monday-Friday at 8 AM
      PHPEEK_PM_PROCESS_REPORTS_ENABLED: "true"
      PHPEEK_PM_PROCESS_REPORTS_COMMAND: "php,artisan,reports:generate"
      PHPEEK_PM_PROCESS_REPORTS_SCHEDULE: "0 8 * * 1-5"
      PHPEEK_PM_PROCESS_REPORTS_RESTART: "never"
      PHPEEK_PM_PROCESS_REPORTS_PRIORITY: "80"
      PHPEEK_PM_PROCESS_REPORTS_ENV_REPORT_TYPE: "daily"
      PHPEEK_PM_PROCESS_REPORTS_ENV_OUTPUT_FORMAT: "pdf"

      # Log rotation - daily at midnight
      PHPEEK_PM_PROCESS_LOG_ROTATION_ENABLED: "true"
      PHPEEK_PM_PROCESS_LOG_ROTATION_COMMAND: "php,artisan,logs:prune,--days=7"
      PHPEEK_PM_PROCESS_LOG_ROTATION_SCHEDULE: "0 0 * * *"
      PHPEEK_PM_PROCESS_LOG_ROTATION_RESTART: "never"
      PHPEEK_PM_PROCESS_LOG_ROTATION_PRIORITY: "90"

      # Queue cleanup - every 6 hours
      PHPEEK_PM_PROCESS_QUEUE_CLEANUP_ENABLED: "true"
      PHPEEK_PM_PROCESS_QUEUE_CLEANUP_COMMAND: "php,artisan,queue:prune-batches"
      PHPEEK_PM_PROCESS_QUEUE_CLEANUP_SCHEDULE: "0 */6 * * *"
      PHPEEK_PM_PROCESS_QUEUE_CLEANUP_RESTART: "never"
      PHPEEK_PM_PROCESS_QUEUE_CLEANUP_PRIORITY: "100"

      # Advanced Logging (v1.1.0+)
      PHPEEK_PM_LOG_MULTILINE_ENABLED: "true"
      PHPEEK_PM_LOG_MULTILINE_PATTERN: '^\[|^\d{4}-|^{"'
      PHPEEK_PM_LOG_MULTILINE_TIMEOUT: "500"
      PHPEEK_PM_LOG_REDACTION_ENABLED: "true"
      PHPEEK_PM_LOG_REDACTION_PATTERNS: "password,api_key,secret,token,auth"

    depends_on:
      - mysql
      - redis
    networks:
      - laravel

  mysql:
    image: mysql:8.3
    container_name: laravel-mysql
    environment:
      MYSQL_DATABASE: laravel
      MYSQL_USER: laravel
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - laravel

  redis:
    image: redis:7-alpine
    container_name: laravel-redis
    networks:
      - laravel

  # Optional: Healthchecks.io integration for external monitoring
  # Sign up at https://healthchecks.io and replace UUIDs below
  #
  # Then update environment variables:
  # PHPEEK_PM_PROCESS_DB_BACKUP_HEARTBEAT_URL: "https://hc-ping.com/your-actual-uuid"

volumes:
  mysql-data:

networks:
  laravel:
    driver: bridge
