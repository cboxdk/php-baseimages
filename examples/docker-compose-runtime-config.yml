# Example: Runtime Configuration Testing
# Demonstrates PHP, Nginx, and SSL configuration via environment variables

services:
  # Test 1: Basic runtime configuration
  app-basic:
    build:
      context: ..
      dockerfile: php-fpm-nginx/8.3/alpine/Dockerfile
    ports:
      - "8080:80"
    volumes:
      - ./test-app:/var/www/html
    environment:
      # PHP Runtime Config
      PHP_MEMORY_LIMIT: 512M
      PHP_MAX_EXECUTION_TIME: 120
      PHP_UPLOAD_MAX_FILE_SIZE: 200M
      PHP_POST_MAX_SIZE: 200M
      PHP_DISPLAY_ERRORS: "On"
      PHP_ERROR_REPORTING: E_ALL

      # Nginx Runtime Config
      NGINX_CLIENT_MAX_BODY_SIZE: 200M
      NGINX_FASTCGI_READ_TIMEOUT: 300s

      # Debug output
      PHPEEK_DEBUG: "true"

  # Test 2: Custom ports
  app-custom-ports:
    build:
      context: ..
      dockerfile: php-fpm-nginx/8.3/alpine/Dockerfile
    ports:
      - "9090:9000"
    volumes:
      - ./test-app:/var/www/html
    environment:
      NGINX_HTTP_PORT: 9000
      PHP_MEMORY_LIMIT: 256M

  # Test 3: SSL with self-signed certificate (auto-generated)
  app-ssl-mixed:
    build:
      context: ..
      dockerfile: php-fpm-nginx/8.3/alpine/Dockerfile
    ports:
      - "8081:80"
      - "8443:443"
    volumes:
      - ./test-app:/var/www/html
    environment:
      SSL_MODE: mixed  # Both HTTP and HTTPS
      NGINX_HTTP_PORT: 80
      NGINX_HTTPS_PORT: 443
      PHP_MEMORY_LIMIT: 512M

  # Test 4: Production-like configuration
  app-production:
    build:
      context: ..
      dockerfile: php-fpm-nginx/8.3/alpine/Dockerfile
    ports:
      - "8082:80"
    volumes:
      - ./test-app:/var/www/html
    environment:
      # PHP Production
      PHP_MEMORY_LIMIT: 1G
      PHP_MAX_EXECUTION_TIME: 180
      PHP_OPCACHE_MEMORY_CONSUMPTION: 512
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "0"
      PHP_OPCACHE_JIT_BUFFER_SIZE: 256M
      PHP_APCU_SHM_SIZE: 128M
      PHP_DISPLAY_ERRORS: "Off"

      # Nginx Production
      NGINX_CLIENT_MAX_BODY_SIZE: 500M
      NGINX_FASTCGI_BUFFERS: "16 16k"
      NGINX_ACCESS_LOG: "off"

      # Laravel Production
      LARAVEL_OPTIMIZE_CONFIG: "true"
      LARAVEL_OPTIMIZE_ROUTE: "true"
      LARAVEL_OPTIMIZE_VIEW: "true"

  # Test 5: High-performance configuration
  app-high-performance:
    build:
      context: ..
      dockerfile: php-fpm-nginx/8.3/alpine/Dockerfile
    ports:
      - "8083:80"
    volumes:
      - ./test-app:/var/www/html
    environment:
      # PHP High Performance
      PHP_MEMORY_LIMIT: 2G
      PHP_MAX_EXECUTION_TIME: 300
      PHP_OPCACHE_MEMORY_CONSUMPTION: 1024
      PHP_OPCACHE_MAX_ACCELERATED_FILES: 50000
      PHP_OPCACHE_JIT: tracing
      PHP_OPCACHE_JIT_BUFFER_SIZE: 512M
      PHP_APCU_SHM_SIZE: 256M

      # Nginx High Performance
      NGINX_CLIENT_MAX_BODY_SIZE: 1G
      NGINX_FASTCGI_BUFFERS: "32 16k"
      NGINX_FASTCGI_BUFFER_SIZE: "32k"
      NGINX_FASTCGI_BUSY_BUFFERS_SIZE: "64k"
      NGINX_ACCESS_LOG: "off"
      NGINX_STATIC_ACCESS_LOG: "off"

  # Test 6: Development environment
  app-dev:
    build:
      context: ..
      dockerfile: php-fpm-nginx/8.3/alpine/Dockerfile
    ports:
      - "8084:80"
    volumes:
      - ./test-app:/var/www/html
    environment:
      # PHP Development
      PHP_MEMORY_LIMIT: 512M
      PHP_DISPLAY_ERRORS: "On"
      PHP_ERROR_REPORTING: E_ALL
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      PHP_OPCACHE_REVALIDATE_FREQ: "0"

      # Nginx Development
      NGINX_ERROR_LOG_LEVEL: debug

      # Laravel Development
      LARAVEL_OPTIMIZE_CONFIG: "false"
      PHPEEK_DEBUG: "true"
