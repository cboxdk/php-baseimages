; =============================================================================
;  Cbox Base Image - PHP-FPM Pool Configuration
;  Production-ready with security hardening
; =============================================================================

[www]
; Pool Configuration
user = www-data
group = www-data

; Listen Configuration
listen = 9000
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; -----------------------------------------------------------------------------
; Process Manager Configuration
; -----------------------------------------------------------------------------
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 500

; Process Idle Timeout
pm.process_idle_timeout = 10s

; Status Page (localhost only - use with nginx restriction)
pm.status_path = /fpm-status
ping.path = /fpm-ping
ping.response = pong

; -----------------------------------------------------------------------------
; Logging
; -----------------------------------------------------------------------------
access.log = /proc/self/fd/2
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"
slowlog = /proc/self/fd/2
request_slowlog_timeout = 5s

; Catch Workers Output
catch_workers_output = yes
decorate_workers_output = no

; -----------------------------------------------------------------------------
; Timeouts
; -----------------------------------------------------------------------------
request_terminate_timeout = 60s

; -----------------------------------------------------------------------------
; SECURITY: Environment Variable Handling
; -----------------------------------------------------------------------------
; IMPORTANT: clear_env = no allows container env vars to pass to PHP
; This is the recommended approach for containerized applications
clear_env = no

; -----------------------------------------------------------------------------
; PHP Admin Values (cannot be overridden by application code)
; -----------------------------------------------------------------------------
php_admin_value[error_log] = /proc/self/fd/2
php_admin_flag[log_errors] = on

; Upload/POST limits (must match nginx client_max_body_size)
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M
php_admin_value[max_file_uploads] = 20

; Memory limits
php_admin_value[memory_limit] = 256M

; Execution time limits
php_admin_value[max_execution_time] = 60
php_admin_value[max_input_time] = 60

; Security: Disable dangerous functions in FPM context
php_admin_value[disable_functions] = pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals

; Security: Restrict open_basedir
php_admin_value[open_basedir] = /var/www/html:/tmp:/var/tmp
